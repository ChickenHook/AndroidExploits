package org.chickenhook.androidexploits.details

import android.os.Bundle
import android.util.Log
import android.view.LayoutInflater
import android.view.View
import android.view.View.OnClickListener
import android.view.ViewGroup
import android.widget.ProgressBar
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import androidx.fragment.app.Fragment
import androidx.navigation.fragment.findNavController
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import io.ktor.client.call.*
import org.chickenh00k.androidexploits.common.Report
import org.chickenh00k.androidexploits.common.communication.ScoreList
import org.chickenhook.androidexploits.*
import org.chickenhook.androidexploits.deviceOverview.DeviceOverviewFragment
import org.chickenhook.androidexploits.reportOverview.GenericScoreItem
import org.chickenhook.androidexploits.reportOverview.IReportOverviewItem

/**
 * A simple [Fragment] subclass.
 * Use the [DetailsListFragment.newInstance] factory method to
 * create an instance of this fragment.
 */
class DetailsListFragment : Fragment() {

    companion object {
        var deviceReport: Report? = null
        const val TAG = "ReportOverviewFragment"

        const val ARG_URL = "url"
        const val ARG_TITLE = "title"
    }


    lateinit var rootView: View

    lateinit var overviewReportPb: ProgressBar
    lateinit var overviewStatusView: TextView

    fun onLoadingStart() {
        overviewReportPb.visibility = View.VISIBLE
        overviewStatusView.visibility = View.GONE
    }

    fun onLoadingEnd() {
        overviewReportPb.visibility = View.GONE
        overviewStatusView.visibility = View.GONE
    }

    fun onLoadingError(message: String) {
        overviewStatusView.visibility = View.VISIBLE
        overviewStatusView.setText(message)
    }


    private var url_var: String? = null
    private var title_var: String? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        arguments?.let {
            url_var = it.getString(ARG_URL)
            title_var = it.getString(ARG_TITLE)
        }
    }

    fun openDeviceFragment(model: String, title: String) {
        val args = Bundle()
        args.putSerializable(DeviceOverviewFragment.ARG_MODEL, model)
        args.putSerializable(DeviceOverviewFragment.ARG_TITLE, title)
        findNavController().navigate(R.id.action_DetailsFragment_to_DeviceOverviewFragment, args)
    }
    fun openDetails(url: String, title: String) {
        val args = Bundle()
        args.putSerializable(DetailsListFragment.ARG_URL, url)
        args.putSerializable(DetailsListFragment.ARG_TITLE, title)
        findNavController().navigate(R.id.action_to_DetailsListFragment, args)
    }
    fun openOverview(url: String, title: String) {
        val args = Bundle()
        args.putSerializable(DetailsListFragment.ARG_URL, url)
        args.putSerializable(DetailsListFragment.ARG_TITLE, title)
        findNavController().navigate(R.id.action_to_GenericOverviewFragment, args)
    }

    fun getMainActivity(): MainActivity? {
        val activtiy = requireActivity()
        if (activtiy is MainActivity) {
            return activtiy
        }
        return null
    }



    fun initRecyclerView() {

        if(url_var == null || title_var == null) {
            throw java.lang.IllegalArgumentException("ARG_URL and ARG_TITLE must be set")
        }

        val values = ArrayList<IReportOverviewItem>()

        val recyclerView = rootView.findViewById<RecyclerView>(R.id.report_card_overview_list)
        if (recyclerView is RecyclerView) {
            with(recyclerView) {
                layoutManager = LinearLayoutManager(context)
                adapter = DeviceCardReportAdapter(values)
            }
        }
        (requireActivity() as AppCompatActivity).supportActionBar?.title = title_var

        getMainActivity()?.let {
            onLoadingStart()
            it.sendGenericRequest<ScoreList?>(url_var!!) { list ->
                list?.items?.forEach {listItem ->
                    requireActivity().runOnUiThread {
                        var description: String? = null
                        var title = listItem.name
                        var onClick =
                            OnClickListener { openDeviceFragment(listItem.name, title) }

                        listItem.appendix.forEach {pair ->
                            if(pair.first == "title") {
                                title = pair.second
                            } else if(pair.first == "click") {
                                onClick =
                                    OnClickListener { openDetails(pair.second, title) }
                            }else if(pair.first == "overview") {
                                onClick =
                                    OnClickListener { openOverview(pair.second, title) }
                            } else if(pair.first == "description") {
                                description = pair.second
                            }
                        }
                        onLoadingEnd()
                        values.add(
                            GenericScoreItem (
                                title,
                                listItem.score,
                                description,
                                onClick
                            )
                        )
                        recyclerView.adapter?.notifyItemInserted(values.size)
                    }
                } ?: kotlin.run {
                    onLoadingError(getString(R.string.report_status_network_error))
                }

            }
        } ?: kotlin.run {
            Log.d(MyDeviceOverviewFragment.TAG, "Fragment is not attached!")
        }
    }

    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        // Inflate the layout for this fragment
        rootView = inflater.inflate(R.layout.fragment_report_card_overview, container, false)
        overviewReportPb = rootView.findViewById(R.id.progress_pb)
        overviewStatusView = rootView.findViewById(R.id.progress_status)
        initRecyclerView()
        return rootView
    }

}