package org.chickenhook.androidexploits

import android.content.ComponentName
import android.content.Intent
import android.content.ServiceConnection
import android.os.Bundle
import android.os.IBinder
import android.util.Log
import android.view.Menu
import android.view.MenuItem
import androidx.appcompat.app.AppCompatActivity
import androidx.appcompat.app.AppCompatDelegate
import androidx.core.view.WindowCompat
import androidx.navigation.NavController
import androidx.navigation.NavOptions
import androidx.navigation.findNavController
import androidx.navigation.fragment.findNavController
import androidx.navigation.ui.AppBarConfiguration
import androidx.navigation.ui.navigateUp
import androidx.navigation.ui.setupActionBarWithNavController
import androidx.preference.PreferenceManager
import com.google.android.material.snackbar.Snackbar
import org.chickenhook.androidexploits.databinding.ActivityMainBinding
import org.chickenhook.androidexploits.settings.SettingsActivity
import org.chickenhook.androidexploits.settings.SettingsManager
import org.chickenhook.service.AndroidExploitsService


class MainActivity : AppCompatActivity() {

    val TAG = "MainActivity"

    private lateinit var appBarConfiguration: AppBarConfiguration
    private lateinit var binding: ActivityMainBinding

    val serviceConnectionListeners = ArrayList<(AndroidExploitsService.ServiceBinder?) -> Unit>()
    var connected = false
    var service: AndroidExploitsService.ServiceBinder? = null
    lateinit var navController: NavController

    fun bindService() {
        val i = Intent(this, AndroidExploitsService::class.java)
        startService(i)
        bindService(i, object : ServiceConnection {
            override fun onServiceConnected(p0: ComponentName?, p1: IBinder?) {
                connected = true
                service = p1 as AndroidExploitsService.ServiceBinder?
                serviceConnectionListeners.forEach {
                    it(service)
                }
            }

            override fun onServiceDisconnected(p0: ComponentName?) {
                connected = false
            }

        }, 0)
        serviceConnectionListeners.add(::onConnected)
    }

    fun onConnected(service: AndroidExploitsService.ServiceBinder?) {
        Log.d(TAG, "Connected to service [+] $service")
    }



    fun setUpMode() {
        val navOptions: NavOptions = NavOptions.Builder()
            .setPopUpTo(R.id.RequestDeviceReportFragment, true)
            .build()
        val bundle = Bundle()
        navController.navigate(R.id.action_setup, bundle, navOptions);
//        navController.clearBackStack(R.id.FirstFragment)
    }

    fun openUrl(title: String, url: String) {
        val args = Bundle()
        args.putSerializable(IncidenceFragment.ARG_CONTENT, url)
        args.putSerializable(IncidenceFragment.ARG_TITLE,
            title
        )
        navController.navigate(R.id.action_to_IncidenceFragment, args)
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        WindowCompat.setDecorFitsSystemWindows(window, false)
        super.onCreate(savedInstanceState)
        AppCompatDelegate.setDefaultNightMode(AppCompatDelegate.MODE_NIGHT_YES)

        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)

        setSupportActionBar(binding.toolbar)

        navController = findNavController(R.id.nav_host_fragment_content_main)

        appBarConfiguration = AppBarConfiguration(navController.graph)
        setupActionBarWithNavController(navController, appBarConfiguration)

        binding.fab.setOnClickListener { view ->
            Snackbar.make(view, "Replace with your own action", Snackbar.LENGTH_LONG)
                .setAnchorView(R.id.fab)
                .setAction("Action", null).show()
        }
        if(!SettingsManager.getBoolean("setup", false, this)) {
            setUpMode()
        }
    }

    override fun onResume() {
        super.onResume()
        bindService()
    }

    override fun onCreateOptionsMenu(menu: Menu): Boolean {
        // Inflate the menu; this adds items to the action bar if it is present.
        menuInflater.inflate(R.menu.menu_main, menu)
        return true
    }

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
        // Handle action bar item clicks here. The action bar will
        // automatically handle clicks on the Home/Up button, so long
        // as you specify a parent activity in AndroidManifest.xml.
        return when (item.itemId) {
//            R.id.action_settings -> {
//                navController.navigate(R.id.action_show_settings)
//                true
//            }
            R.id.action_show_about -> {
                openUrl("ABOUT", "https://androidreverse.org")
                true
            }

            R.id.action_show_data_privacy_policy -> {
                openUrl("DATA PRIVACY POLICY", "https://androidreverse.org")
                true
            }

            R.id.action_show_device_info -> {
                navController.navigate(R.id.action_show_DeviceInfo)
                true
            }
            else ->
                super.onOptionsItemSelected(item)
        }
    }

    override fun onSupportNavigateUp(): Boolean {
        navController = findNavController(R.id.nav_host_fragment_content_main)
        return navController.navigateUp(appBarConfiguration)
                || super.onSupportNavigateUp()
    }

    fun getConnection(onConnected: (AndroidExploitsService.ServiceBinder?) -> Unit) {
        if (connected && service != null) {
            onConnected(service)
            Log.d(TAG, "Service is already connected")
        } else {
            serviceConnectionListeners.add { service ->
                onConnected(service)
            }
            Log.d(TAG, "Waiting for service connection")
        }
    }

    fun setActivityTitle(title: String) {
        supportActionBar?.title = title
    }

}