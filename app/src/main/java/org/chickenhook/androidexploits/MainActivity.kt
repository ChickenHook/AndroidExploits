package org.chickenhook.androidexploits

import android.content.ComponentName
import android.content.Intent
import android.content.ServiceConnection
import android.os.Build
import android.os.Bundle
import android.os.IBinder
import android.util.Log
import android.view.Menu
import android.view.MenuItem
import androidx.appcompat.app.AppCompatActivity
import androidx.appcompat.app.AppCompatDelegate
import androidx.core.view.WindowCompat
import androidx.drawerlayout.widget.DrawerLayout
import androidx.navigation.NavController
import androidx.navigation.NavOptions
import androidx.navigation.findNavController
import androidx.navigation.fragment.findNavController
import androidx.navigation.ui.AppBarConfiguration
import androidx.navigation.ui.navigateUp
import androidx.navigation.ui.setupActionBarWithNavController
import androidx.navigation.ui.setupWithNavController
import androidx.preference.PreferenceManager
import com.google.android.material.appbar.AppBarLayout
import com.google.android.material.navigation.NavigationView
import com.google.android.material.snackbar.Snackbar
import io.ktor.client.call.*
import kotlinx.coroutines.GlobalScope
import kotlinx.coroutines.async
import org.chickenhook.androidexploits.databinding.ActivityMainBinding
import org.chickenhook.androidexploits.details.DetailsListFragment
import org.chickenhook.androidexploits.deviceOverview.DeviceOverviewFragment
import org.chickenhook.androidexploits.settings.SettingsActivity
import org.chickenhook.androidexploits.settings.SettingsManager
import org.chickenhook.service.AndroidExploitsService


class MainActivity : AppCompatActivity() {

    val TAG = "MainActivity"

    private lateinit var appBarConfiguration: AppBarConfiguration
    private lateinit var binding: ActivityMainBinding

    val serviceConnectionListeners = ArrayList<(AndroidExploitsService.ServiceBinder?) -> Unit>()
    var connected = false
    var service: AndroidExploitsService.ServiceBinder? = null
    lateinit var navController: NavController

    fun bindService() {
        val i = Intent(this, AndroidExploitsService::class.java)
        startService(i)
        bindService(i, object : ServiceConnection {
            override fun onServiceConnected(p0: ComponentName?, p1: IBinder?) {
                connected = true
                service = p1 as AndroidExploitsService.ServiceBinder?
                serviceConnectionListeners.forEach {
                    it(service)
                }
            }

            override fun onServiceDisconnected(p0: ComponentName?) {
                connected = false
            }

        }, 0)
        serviceConnectionListeners.add(::onConnected)
    }

    fun onConnected(service: AndroidExploitsService.ServiceBinder?) {
        Log.d(TAG, "Connected to service [+] $service")
    }


    fun setUpMode() {
        val navOptions: NavOptions = NavOptions.Builder()
            .setPopUpTo(R.id.RequestDeviceReportFragment, true)
            .build()
        val bundle = Bundle()
        navController.navigate(R.id.action_setup, bundle, navOptions);
//        navController.clearBackStack(R.id.FirstFragment)
    }

    fun openUrl(title: String, url: String) {
        val args = Bundle()
        args.putSerializable(IncidenceFragment.ARG_CONTENT, url)
        args.putSerializable(
            IncidenceFragment.ARG_TITLE,
            title
        )
        navController.navigate(R.id.action_to_IncidenceFragment, args)
    }

    fun openDeviceFragment(model: String, title: String) {
        val args = Bundle()
        args.putSerializable(DeviceOverviewFragment.ARG_MODEL, model)
        args.putSerializable(DeviceOverviewFragment.ARG_TITLE, title)
        navController.navigate(R.id.action_to_DeviceOverviewFragment, args)
    }

    fun openOverview(url: String, title: String) {
        val args = Bundle()
        args.putSerializable(DetailsListFragment.ARG_URL, url)
        args.putSerializable(DetailsListFragment.ARG_TITLE, title)
        navController.navigate(R.id.action_to_GenericOverviewFragment, args)
    }

    fun openDetails(url: String, title: String) {
        val args = Bundle()
        args.putSerializable(DetailsListFragment.ARG_URL, url)
        args.putSerializable(DetailsListFragment.ARG_TITLE, title)
        navController.navigate(R.id.action_to_DetailsListFragment, args)
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        WindowCompat.setDecorFitsSystemWindows(window, false)
        super.onCreate(savedInstanceState)
        AppCompatDelegate.setDefaultNightMode(AppCompatDelegate.MODE_NIGHT_YES)

        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)

        setSupportActionBar(binding.toolbar)

        navController = findNavController(R.id.nav_host_fragment_content_main)

        appBarConfiguration = AppBarConfiguration(navController.graph, binding.drawerLayout)
        setupActionBarWithNavController(navController, appBarConfiguration)
        val navigationView = findViewById<NavigationView>(R.id.nav_view)

        navigationView.setupWithNavController(navController)
        navigationView.setNavigationItemSelectedListener {
            when(it.itemId) {
                R.id.action_show_manufacturers -> {
                    openDetails("manufacturerScores", getString(R.string.action_show_manufactureres_label))
                    binding.drawerLayout.close()
                }
                R.id.action_show_androidversions -> {
                    openDetails("androidVersionScores", getString(R.string.action_show_androidversions_label))
                    binding.drawerLayout.close()
                }
                R.id.action_show_devicemodels -> {
                    openDetails("modelScores", getString(R.string.action_show_devicemodels_label))
                    binding.drawerLayout.close()
                }
                R.id.action_show_securitypatches -> {
                    openDetails("securitypatch/scores", getString(R.string.action_show_securitypatches_label))
                    binding.drawerLayout.close()
                }
                R.id.action_show_incidences -> {
                    openDetails("incidence/share", getString(R.string.action_show_incidences_label))
                    binding.drawerLayout.close()
                }
                R.id.action_show_properties -> {
                    openDetails("feature/share", getString(R.string.action_show_properties_label))
                    binding.drawerLayout.close()
                }
                R.id.action_show_webviews -> {
                    openDetails("webview/share", getString(R.string.action_show_webview_label))
                    binding.drawerLayout.close()
                }
            }
            true
        }

        binding.fab.setOnClickListener { view ->
            Snackbar.make(view, "Replace with your own action", Snackbar.LENGTH_LONG)
                .setAnchorView(R.id.fab)
                .setAction("Action", null).show()
        }
        if (!SettingsManager.getBoolean("setup", false, this)) {
            setUpMode()
        }
    }

    override fun onResume() {
        super.onResume()
        bindService()
    }

    override fun onCreateOptionsMenu(menu: Menu): Boolean {
        // Inflate the menu; this adds items to the action bar if it is present.
        menuInflater.inflate(R.menu.menu_main, menu)
        return true
    }

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
        // Handle action bar item clicks here. The action bar will
        // automatically handle clicks on the Home/Up button, so long
        // as you specify a parent activity in AndroidManifest.xml.
        return when (item.itemId) {
//            R.id.action_settings -> {
//                navController.navigate(R.id.action_show_settings)
//                true
//            }
            R.id.action_show_about -> {
                openUrl("ABOUT", resources.getString(R.string.url_about))
                true
            }

            R.id.action_show_data_privacy_policy -> {
                openUrl(
                    "DATA PRIVACY POLICY",
                    resources.getString(R.string.url_data_privacy_policy)
                )
                true
            }

            R.id.action_show_device_info -> {
                navController.navigate(R.id.action_show_DeviceInfo)
                true
            }
            else ->
                super.onOptionsItemSelected(item)
        }
    }

    override fun onSupportNavigateUp(): Boolean {
        navController = findNavController(R.id.nav_host_fragment_content_main)
        return navController.navigateUp(appBarConfiguration)
                || super.onSupportNavigateUp()
    }

    fun getConnection(onConnected: (AndroidExploitsService.ServiceBinder?) -> Unit) {
        if (connected && service != null) {
            onConnected(service)
            Log.d(TAG, "Service is already connected")
        } else {
            serviceConnectionListeners.add { service ->
                onConnected(service)
            }
            Log.d(TAG, "Waiting for service connection")
        }
    }


    inline fun <reified T> sendGenericRequest(itemName: String, crossinline callback: (T) -> Unit) {

        getConnection { service ->
            val result = service?.sendGenericRequest(itemName) {
                GlobalScope.async {
                    it?.let {
                        callback(it.body())
                    }
                }
            }
        }
    }

    fun setActivityTitle(title: String) {
        supportActionBar?.title = title
    }

}