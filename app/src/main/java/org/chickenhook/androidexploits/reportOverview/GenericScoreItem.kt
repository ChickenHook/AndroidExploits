package org.chickenhook.androidexploits.reportOverview

import android.view.View
import android.view.ViewGroup
import android.widget.ProgressBar
import android.widget.TextView
import org.chickenh00k.androidexploits.common.UrlConstants
import org.chickenh00k.androidexploits.common.communication.ScoreListItem
import org.chickenhook.androidexploits.R

// TODO change to ScoreListItem

open class GenericScoreItem(
    val title: String,
    val score: Double,
    val description: String? = null,
    onClick: View.OnClickListener? = null
) :
    IReportOverviewItem(onClick) {

    constructor(scoreListItem: ScoreListItem, onClick: View.OnClickListener? = null) : this(
        scoreListItem.name,
        scoreListItem.score,
        parseCount(scoreListItem),
        onClick = onClick
    )


    open class ViewHolder(parent: ViewGroup, resId: Int) :
        IReportOverviewItemViewHolder(parent, resId) {
        override fun bind(item: IReportOverviewItem) {
            if (!(item is GenericScoreItem)) {
                throw java.lang.RuntimeException("Invalid object type <${item}>")
            }
            itemView.findViewById<TextView>(R.id.generic_score_item_score_title)?.let {
                it.text = item.title
            }
            item.description?.let { description ->
                itemView.findViewById<TextView>(R.id.generic_score_item_score_description)?.let {
                    it.text = description
                }
            }
            val pb = itemView.findViewById<ProgressBar>(R.id.generic_score_item_score_pb)
            pb.max = 100
            pb.progress = (10.0 * item.score).toInt()
            val anim = ProgressBarAnimation(pb, 0.0f, pb.progress.toFloat())
            anim.duration = 1000
            pb.startAnimation(anim)
            itemView.setOnClickListener(item.onClick)
        }
    }

    companion object {
        val TYPE_ID = 1

        fun parseCount(scoreListItem: ScoreListItem): String? {
            scoreListItem.appendix.forEach {
                if (it.first.equals(UrlConstants.OVERVIEW_COUNT)) {
                    return it.second
                }
            }
            return null
        }
    }
}