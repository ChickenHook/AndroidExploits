package org.chickenhook.androidexploits.reportOverview

import android.graphics.Color
import android.util.Log
import android.view.View
import android.view.ViewGroup
import android.widget.TextView
import com.github.mikephil.charting.charts.BarChart
import com.github.mikephil.charting.charts.LineChart
import com.github.mikephil.charting.components.AxisBase
import com.github.mikephil.charting.components.XAxis
import com.github.mikephil.charting.components.YAxis
import com.github.mikephil.charting.data.BarData
import com.github.mikephil.charting.data.BarDataSet
import com.github.mikephil.charting.data.BarEntry
import com.github.mikephil.charting.data.Entry
import com.github.mikephil.charting.data.LineData
import com.github.mikephil.charting.data.LineDataSet
import com.github.mikephil.charting.formatter.ValueFormatter
import com.github.mikephil.charting.utils.ColorTemplate
import org.chickenhook.androidexploits.R
import org.chickenhook.androidexploits.tools.Converter
import java.text.SimpleDateFormat
import java.util.*
import java.util.concurrent.TimeUnit
import kotlin.collections.ArrayList


open class BarChartItem(
    val title: String,
    val list: HashMap<Double, Pair<Double, String>>,
    var marker: Double? = null,
    val description: String? = null,
    onClick: View.OnClickListener? = null
) :
    IReportOverviewItem(onClick) {


    open class ViewHolder(parent: ViewGroup, resId: Int) :
        IReportOverviewItemViewHolder(parent, resId) {


        fun configureChart(chart: BarChart, list: HashMap<Double, Pair<Double, String>>) {
            // no description text
            chart.getDescription().setEnabled(false);

            // enable touch gestures
            chart.setTouchEnabled(true);

            chart.setDragDecelerationFrictionCoef(0.9f);

            // enable scaling and dragging
            chart.setDragEnabled(false);
            chart.setScaleEnabled(false);
            chart.setDrawGridBackground(false);
            chart.setHighlightPerDragEnabled(false);

            // set an alternative background color
            chart.setBackgroundColor(Color.TRANSPARENT);
            chart.setViewPortOffsets(0f, 0f, 0f, 0f);

            // get the legend (only possible after setting data)
            val l = chart.legend
            l.isEnabled = false

            val xAxis = chart.xAxis
            xAxis.position = XAxis.XAxisPosition.BOTTOM_INSIDE
//            xAxis.textSize = 10f
            xAxis.textColor = Color.WHITE
            xAxis.setDrawAxisLine(false)
            xAxis.setDrawGridLines(false)
            xAxis.textColor = Converter.getThemeColor(chart.context, android.R.attr.colorSecondary)
            xAxis.setCenterAxisLabels(false)
            xAxis.granularity = 1f // one hour
            xAxis.setValueFormatter(object : ValueFormatter() {

                override fun getFormattedValue(value: Float): String {
                    list[value.toDouble()]?.second?.let {
                        return it
                    }
                    return value.toString()
                }
            })


            val leftAxis = chart.axisLeft
            leftAxis.setPosition(YAxis.YAxisLabelPosition.OUTSIDE_CHART)
            leftAxis.textColor = ColorTemplate.getHoloBlue()
            leftAxis.setDrawGridLines(false)
            leftAxis.isGranularityEnabled = true
//            leftAxis.axisMinimum = 0f
//            leftAxis.spaceMin = 10f
//            leftAxis.axisMaximum = 100f
//            leftAxis.yOffset = -9f
            leftAxis.textColor =
                Converter.getThemeColor(chart.context, android.R.attr.colorSecondary)

            val rightAxis = chart.axisRight
            rightAxis.isEnabled = false
        }

        fun getDataSet(list: HashMap<Double, Pair<Double, String>>, marker: Double? = null): BarData {

            val colors = ArrayList<Int>()
            val values: ArrayList<BarEntry> = ArrayList()
            list.forEach {
                var entry = BarEntry(it.key.toFloat(), (it.value.first * 10.0).toFloat())

                values.add(entry)
                if(marker != null && it.key == marker){
                    colors.add(0xffffff00.toInt())
                } else {
                    colors.add(ColorTemplate.getHoloBlue())
                }
                Log.d(TAG, "Adding value ${it.key.toFloat()} : ${it.value.first.toFloat()}")
            }

            val set1 = BarDataSet(values, "DataSet 1")
            set1.setAxisDependency(YAxis.AxisDependency.LEFT)
//            set1.setColor(ColorTemplate.getHoloBlue())
//            colors.forEach {
//                set1.addColor(it)
//            }
            set1.setColors(colors)
            set1.setValueTextColor(ColorTemplate.getHoloBlue())
            set1.setDrawValues(false)
            set1.setHighLightColor(Color.rgb(244, 117, 117))

            val data = BarData(set1)
            data.setValueTextColor(Color.BLACK)
            data.setValueTextSize(9f)
            return data
        }

        override fun doBind(item: IReportOverviewItem) {
            if (!(item is BarChartItem)) {
                throw java.lang.RuntimeException("Invalid object type <${item}>")
            }
            item.onClick?.let {
                itemView.setOnClickListener(it)
            }
            itemView.findViewById<TextView>(R.id.bar_chartitem_title)?.let {
                it.text = item.title
            }
            val chart = itemView.findViewById<BarChart>(R.id.bar_chartitem_chart)
            chart?.let { chart ->
                configureChart(chart, item.list)
                val dataSet = getDataSet(item.list, item.marker)
                chart.data = dataSet
                chart.setOnClickListener(item.onClick)
            }
        }
    }

    companion object {
        val TYPE_ID = 9

        const val TAG = "BarChartItem"
    }
}