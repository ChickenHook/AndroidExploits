package org.chickenhook.androidexploits

import android.os.Build
import android.os.Bundle
import android.util.Log
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.ProgressBar
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import androidx.fragment.app.Fragment
import androidx.navigation.fragment.findNavController
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.appbar.AppBarLayout
import io.ktor.client.call.*
import org.chickenh00k.androidexploits.common.Report
import org.chickenh00k.androidexploits.common.communication.ScoreList
import org.chickenhook.androidexploits.details.DetailsListFragment
import org.chickenhook.androidexploits.deviceOverview.DeviceOverviewFragment
import org.chickenhook.androidexploits.reportOverview.*
import org.chickenhook.androidexploits.tools.Converter.serverDateConverter
import java.text.SimpleDateFormat
import java.util.*
import kotlin.collections.ArrayList

/**
 * A simple [Fragment] subclass.
 * Use the [MyDeviceOverviewFragment.newInstance] factory method to
 * create an instance of this fragment.
 */
class MyDeviceOverviewFragment : Fragment() {

    companion object {
        var deviceReport: Report? = null
        const val TAG = "ReportOverviewFragment"
    }


    lateinit var rootView: View
    lateinit var overviewReportPb: ProgressBar
    lateinit var overviewStatusView: TextView

    fun onLoadingStart() {
        overviewReportPb.visibility = View.VISIBLE
        overviewStatusView.visibility = View.GONE
    }

    fun onLoadingEnd() {
        overviewReportPb.visibility = View.GONE
        overviewStatusView.visibility = View.GONE
    }

    fun onLoadingError(message: String) {
        overviewStatusView.visibility = View.VISIBLE
        overviewStatusView.setText(message)
    }


    fun getMainActivity(): MainActivity? {
        val activtiy = activity
        if (activtiy is MainActivity) {
            return activtiy
        }
        return null
    }


    fun openDeviceFragment(model: String, title: String) {
        val args = Bundle()
        args.putSerializable(DeviceOverviewFragment.ARG_MODEL, model)
        args.putSerializable(DeviceOverviewFragment.ARG_TITLE, title)
        findNavController().navigate(
            R.id.action_MyDeviceOverviewFragment_to_DeviceOverviewFragment,
            args
        )
    }

    fun openDetails(url: String, title: String) {
        val args = Bundle()
        args.putSerializable(DetailsListFragment.ARG_URL, url)
        args.putSerializable(DetailsListFragment.ARG_TITLE, title)
        findNavController().navigate(R.id.action_Report_to_DetailsFragment, args)
    }


    fun sendRequest() {
        activity?.let {
            if (it is MainActivity) {
                it.getConnection { service ->
                    onLoadingStart()
                    service?.sendDeviceInfo { report ->
                        Log.d(TAG, "device info request sent")
                        it.runOnUiThread {
                            onLoadingEnd()
                            report?.let { report ->
                                deviceReport = report
                                onReport(rootView, report)
                            } ?: kotlin.run {
                                onLoadingError(getString(R.string.report_status_network_error))
                            }
                        }

                    }
                }
            } else {
                Log.d(TAG, "didn't text from service... not MainActivity")
            }
        } ?: kotlin.run {
            Log.d(TAG, "Fragment is not attached!")
        }
    }

    fun onReport(view: View, report: Report) {
//        view.findViewById<TextView>(R.id.report_overview_score_text)?.let {
//            it.text = (report.multiplier * 10.0).toInt().toString()
//        }
//        val pb = view.findViewById<ProgressBar>(R.id.report_overview_score_pb)
//        pb.max = 100
//        pb.progress = (10.0 * report.multiplier).toInt()
//        val anim = ProgressBarAnimation(pb, 0.0f, pb.progress.toFloat())
//        anim.duration = 1000
//        pb.startAnimation(anim)
//
//        val description = view.findViewById<TextView>(R.id.report_overview_description)
//        description?.text = report.message
//
//        val fixButton = view.findViewById<Button>(R.id.report_overview_fix_button)
//        if (report.multiplier < 9) {
//            fixButton.isEnabled = true
//            fixButton.setOnClickListener {
//                startActivity(Intent("android.settings.SYSTEM_UPDATE_SETTINGS"))
//            }
//        } else {
//            fixButton.isEnabled = false
//        }

        val values = ArrayList<IReportOverviewItem>()
        values.add(MyDeviceScoreItem(report.multiplier))

        val list = view.findViewById<RecyclerView>(R.id.report_card_overview_list)
        if (list is RecyclerView) {
            with(list) {
                layoutManager = LinearLayoutManager(context)
                adapter = DeviceCardReportAdapter(values)
//                (adapter as DeviceReportAdapter)?.onClickListener = { pos, content ->
//
//                    val args = Bundle()
//                    args.putSerializable(IncidenceFragment.ARG_CONTENT, content)
//                    args.putSerializable(
//                        IncidenceFragment.ARG_TITLE,
//                        report.properties[pos].key
//                    )
//                    findNavController().navigate(R.id.action_Report_to_IncidenceFragment, args)
//                }

//                val dividerItemDecoration = DividerItemDecoration(
//                    getContext(),
//                    DividerItemDecoration.VERTICAL
//                )
//                addItemDecoration(dividerItemDecoration)
            }
        }
        if (report.incidences.isNotEmpty()) {
            values.add(IncidencesItem(report.incidences))
            list.adapter?.notifyItemInserted(values.size)
        }


//        report.incidences.forEach {
//            values.add(GenericScoreItem(it.name, it.multiplier * 10.0))
//            list.adapter?.notifyItemInserted(values.size)
//        }
        getMainActivity()?.let {
            it.sendGenericRequest<Double>("androidVersionScore/${Build.VERSION.SDK_INT}") {
                requireActivity().runOnUiThread {
                    values.add(
                        GenericScoreItem(
                            "AndroidVersion ${Build.VERSION.SDK_INT} average",
                            it
                        ) {
                            openDetails(
                                "androidversion/${Build.VERSION.SDK_INT}/devices/score",
                                Build.VERSION.SDK_INT.toString()
                            )
                        }
                    )
                    list.adapter?.notifyItemInserted(values.size)
                }
            }
            it.sendGenericRequest<Double>("modelScore/${Build.MODEL}") {
                requireActivity().runOnUiThread {
                    values.add(GenericScoreItem("Model ${Build.MODEL} average", it) { view ->
                        openDeviceFragment(Build.MODEL, Build.MODEL)
                    })
                    list.adapter?.notifyItemInserted(values.size)
                }
            }
            it.sendGenericRequest<Double>("manufacturerScore/${Build.MANUFACTURER}") {
                requireActivity().runOnUiThread {
                    values.add(
                        GenericScoreItem(
                            "Manufacturer ${Build.MANUFACTURER} average",
                            it
                        ) {
                            openDetails(
                                "manufacturer/${Build.MANUFACTURER}/devices/score",
                                Build.MANUFACTURER
                            )
                        }
                    )
                    list.adapter?.notifyItemInserted(values.size)
                }
            }
            it.getConnection {connection->
                connection?.let { service ->
                    it.sendGenericRequest<ScoreList>("device/${service.getDeviceName()}/history/score") {
                        val history = HashMap<Date, Double>()
                        it.items.forEach {
                            serverDateConverter(it.name)?.let {date->
                                history[date] = it.score
                            }
                        }
                        requireActivity().runOnUiThread {
                            values.add(
                                HistoryItem(
                                    getString(R.string.score_history_label),
                                    history
                                ) {
                                    openDetails(
                                        "manufacturer/${Build.MANUFACTURER}/devices/score",
                                        Build.MANUFACTURER
                                    )
                                }
                            )
                            list.adapter?.notifyItemInserted(values.size)
                        }
                    }

                }
            }
        } ?: kotlin.run {
            Log.d(TAG, "Fragment is not attached!")
        }
    }

    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {

        // Inflate the layout for this fragment
        rootView = inflater.inflate(R.layout.fragment_report_card_overview, container, false)


        overviewReportPb = rootView.findViewById(R.id.progress_pb)
        overviewStatusView = rootView.findViewById(R.id.progress_status)
        deviceReport?.let { report ->
            onReport(rootView, report)
        } ?: kotlin.run {
            sendRequest()
        }
        return rootView
    }

}