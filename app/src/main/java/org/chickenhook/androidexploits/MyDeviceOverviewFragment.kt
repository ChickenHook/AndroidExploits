package org.chickenhook.androidexploits

import android.os.Build
import android.os.Bundle
import android.util.Log
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.webkit.WebView
import android.widget.ProgressBar
import android.widget.TextView
import androidx.fragment.app.Fragment
import androidx.navigation.fragment.findNavController
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import androidx.swiperefreshlayout.widget.SwipeRefreshLayout
import io.ktor.client.call.*
import org.chickenh00k.androidexploits.common.Report
import org.chickenh00k.androidexploits.common.communication.ScoreList
import org.chickenh00k.androidexploits.common.communication.ScoreListItem
import org.chickenhook.androidexploits.details.GenericOverviewFragment
import org.chickenhook.androidexploits.deviceOverview.DeviceOverviewFragment
import org.chickenhook.androidexploits.reportOverview.*
import org.chickenhook.androidexploits.tools.Converter.serverDateConverter
import org.chickenhook.androidexploits.webview.MovableWebWindow
import java.util.*
import kotlin.collections.ArrayList

/**
 * A simple [Fragment] subclass.
 * Use the [MyDeviceOverviewFragment.newInstance] factory method to
 * create an instance of this fragment.
 */
class MyDeviceOverviewFragment : Fragment() {

    companion object {
        var deviceReport: Report? = null
        const val TAG = "ReportOverviewFragment"
    }


    lateinit var rootView: View
    lateinit var overviewReportPb: ProgressBar
    lateinit var overviewStatusView: TextView
    lateinit var refreshLayout: SwipeRefreshLayout

    var state = GenericOverviewFragment.LoadingState.LOADING

    fun setLoadingState(state: GenericOverviewFragment.LoadingState) {
        activity?.runOnUiThread {
            when (state) {
                GenericOverviewFragment.LoadingState.LOADING -> refreshLayout.isRefreshing = true
                GenericOverviewFragment.LoadingState.FINISHED -> refreshLayout.isRefreshing = false
            }
        }
    }

    fun onLoadingStart() {
        overviewReportPb.visibility = View.VISIBLE
        overviewStatusView.visibility = View.GONE
    }

    fun onLoadingEnd() {
        overviewReportPb.visibility = View.GONE
        overviewStatusView.visibility = View.GONE
    }

    fun onLoadingError(message: String) {
        overviewStatusView.visibility = View.VISIBLE
        overviewStatusView.setText(message)
    }


    fun getMainActivity(): MainActivity? {
        val activtiy = activity
        if (activtiy is MainActivity) {
            return activtiy
        }
        return null
    }


    fun openDeviceFragment(model: String, title: String) {
        val args = Bundle()
        args.putSerializable(DeviceOverviewFragment.ARG_MODEL, model)
        args.putSerializable(DeviceOverviewFragment.ARG_TITLE, title)
        findNavController().navigate(
            R.id.action_MyDeviceOverviewFragment_to_DeviceOverviewFragment,
            args
        )
    }


    fun sendRequest() {
        activity?.let {
            if (it is MainActivity) {
                it.getConnection { service ->
                    onLoadingStart()
                    service?.sendDeviceInfo { report ->
                        Log.d(TAG, "device info request sent")
                        it.runOnUiThread {
                            onLoadingEnd()
                            report?.let { report ->
                                deviceReport = report
                                onReport(rootView, report)
                            } ?: kotlin.run {
                                onLoadingError(getString(R.string.report_status_network_error))
                            }
                        }

                    }
                }
            } else {
                Log.d(TAG, "didn't text from service... not MainActivity")
            }
        } ?: kotlin.run {
            Log.d(TAG, "Fragment is not attached!")
        }
    }


    private val onHelpClicked: ((String?) -> Unit) = {
        it?.let {url ->
            context?.let {
                MovableWebWindow(rootView as ViewGroup, it, url).show()
            }
        }
    }

    fun addGenericScoreListItemAsync(
        activity: MainActivity,
        list: RecyclerView,
        values: ArrayList<IReportOverviewItem>,
        url: String,
        title: String,
        onClick: View.OnClickListener? = null
    ) {
        var item = GenericScoreListItem(title, ScoreList(kotlin.collections.ArrayList()))
        var id = values.size
        activity.runOnUiThread {
            values.add(id, item)
            list.adapter?.notifyItemInserted(id)
        }

        activity.sendGenericRequest<ScoreList>(url) { scoreList ->
            requireActivity().runOnUiThread {
                item.update(
                    title, scoreList, onClick
                )
                list.adapter?.notifyItemChanged(id)
            }
        }
    }


    fun addGenericScoreItemAsync(
        activity: MainActivity,
        list: RecyclerView,
        values: ArrayList<IReportOverviewItem>,
        url: String,
        onClick: View.OnClickListener? = null
    ) {
        var item = GenericScoreItem()
        item.onHelpClicked = onHelpClicked
        var id = values.size
        activity.runOnUiThread {
            values.add(id, item)
            list.adapter?.notifyItemInserted(id)
        }

        activity.sendGenericRequest<ScoreListItem>(url) {
            requireActivity().runOnUiThread {
                item.update(
                    it, onClick
                )
                list.adapter?.notifyItemChanged(id)
            }
        }
    }

    fun addBarChartItem(
        activity: MainActivity,
        list: RecyclerView,
        values: ArrayList<IReportOverviewItem>,
        title: String,
        url: String,
        marker: String,
        onClick: View.OnClickListener? = null
    ) {
        val data = HashMap<Double, Pair<Double, String>>()
        val item = BarChartItem(
            title,
            data,
            onClick = onClick
        )
        item.onHelpClicked = onHelpClicked

        val id = values.size
        values.add(item)

        list.adapter?.notifyItemInserted(id)

        activity.sendGenericRequest<ScoreList>(url) {
            item.helpText = GenericScoreItem.parseHelp(it.appendix)
            var i = 0
            it.items.forEach {
                var title = it.name
                it.appendix.forEach { pair ->
                    if (pair.first == "title") {
                        title = pair.second
                    }
                }

                val f = it.name.toIntOrNull()
                if (f != null) {
                    i = f
                }
                if (it.name.equals(marker)) {
                    item.marker = i.toDouble()
                }
                data[i.toDouble()] = Pair(it.score, title) //todo get android version name
                i += 1
            }
            requireActivity().runOnUiThread {
                list.adapter?.notifyItemChanged(id)
            }

        }
    }

    fun addHistoryItem(
        activity: MainActivity,
        list: RecyclerView,
        values: ArrayList<IReportOverviewItem>,
        url: String,
        onClick: View.OnClickListener? = null
    ) {

        val history = HashMap<Date, Double>()
        val item = HistoryItem(
            getString(R.string.score_history_label),
            history,
            onClick = onClick
        )
        val id = values.size
        values.add(item)

        list.adapter?.notifyItemInserted(id)

        activity.sendGenericRequest<ScoreList>(url) {
            it.items.forEach {
                serverDateConverter(it.name)?.let { date ->
                    history[date] = it.score
                }
            }
            requireActivity().runOnUiThread {
                setLoadingState(GenericOverviewFragment.LoadingState.FINISHED)
                list.adapter?.notifyItemChanged(id)
            }

        }
    }

    fun onReport(view: View, report: Report) {


        val values = ArrayList<IReportOverviewItem>()
        values.add(MyDeviceScoreItem(report.multiplier))

        val list = view.findViewById<RecyclerView>(R.id.report_card_overview_list)
        if (list is RecyclerView) {
            with(list) {
                layoutManager = LinearLayoutManager(context)
                adapter = DeviceCardReportAdapter(values)
            }
        }

        values.add(DeviceStateItem(report.incidences.isEmpty()))
        if (report.incidences.isNotEmpty()) {
            values.add(IncidencesItem(report.incidences))
            list.adapter?.notifyItemInserted(values.size)
        }


        getMainActivity()?.let { activity ->
            activity.getConnection { connection ->
                connection?.let { service ->
                    addHistoryItem(
                        activity,
                        list,
                        values,
                        "device/${service.getDeviceName()}/history/score"
                    ) {
                        activity.openDetails(
                            "manufacturer/${Build.MANUFACTURER}/devices/score",
                            Build.MANUFACTURER
                        )
                    }
                }
            }

            addGenericScoreItemAsync(
                activity,
                list,
                values,
                "androidVersionScore/${Build.VERSION.SDK_INT}"
            ) {
                activity.openOverview(
                    "androidversion/${Build.VERSION.SDK_INT.toString()}/overview",
                    Build.VERSION.SDK_INT.toString()
                )
            }

            addGenericScoreItemAsync(
                activity,
                list,
                values,
                "modelScore/${Build.MODEL}"
            ) { view ->
                activity.openOverview("model/${Build.MODEL}/overview", Build.MODEL)
            }
            addGenericScoreItemAsync(
                activity,
                list,
                values,
                "manufacturerScore/${Build.MANUFACTURER}"
            ) {
                activity.openOverview(
                    "manufacturer/${Build.MANUFACTURER}/overview",
                    Build.MANUFACTURER
                )
            }

            addGenericScoreListItemAsync(
                activity,
                list,
                values,
                "model/${Build.MODEL}/features/share?limit=4",
                getString(R.string.features)
            ) {
                activity.openDetails(
                    "feature/share",
                    getString(R.string.action_show_properties_label)
                )
            }
            var webViewVersion = ""
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                val webViewPackage = WebView.getCurrentWebViewPackage()
                webViewPackage?.let {
                    webViewVersion = it.versionName
                    addGenericScoreItemAsync(
                        activity,
                        list,
                        values,
                        "webview/${it.packageName}/overview"
                    )
                }

                addGenericScoreListItemAsync(
                    activity,
                    list,
                    values,
                    "model/${Build.MODEL}/webviewversion/share",
                    getString(R.string.action_show_webview_label)
                ) {
                    activity.openDetails(
                        "webview/share",
                        getString(R.string.action_show_webview_label)
                    )
                }


            }
            addBarChartItem(
                activity,
                list,
                values,
                getString(R.string.action_show_androidversions_label),
                "androidVersionScores",
                Build.VERSION.SDK_INT.toString()
            ) {
                activity.openDetails(
                    "androidVersionScores",
                    getString(R.string.action_show_androidversions_label)
                )
            }
            addBarChartItem(
                activity,
                list,
                values,
                getString(R.string.webview_versions),
                "model/${Build.MODEL}/webviewversion/share",
                webViewVersion
            ) {
                activity.openDetails("webview/share", getString(R.string.action_show_webview_label))
            }

            addBarChartItem(
                activity,
                list,
                values,
                getString(R.string.action_show_manufactureres_label),
                "manufacturerScores",
                Build.MANUFACTURER
            ) {
                activity.openDetails(
                    "manufacturerScores",
                    getString(R.string.action_show_manufactureres_label)
                )
            }

        } ?: kotlin.run {
            Log.d(TAG, "Fragment is not attached!")
        }
    }

    fun checkReport() {
        setLoadingState(GenericOverviewFragment.LoadingState.LOADING)
        deviceReport?.let { report ->
            onReport(rootView, report)
        } ?: kotlin.run {
            sendRequest()
        }
    }

    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {

        // Inflate the layout for this fragment
        rootView = inflater.inflate(R.layout.fragment_report_card_overview, container, false)


        overviewReportPb = rootView.findViewById(R.id.progress_pb)
        overviewStatusView = rootView.findViewById(R.id.progress_status)
        refreshLayout = rootView.findViewById(R.id.swipe_container)
        refreshLayout.setOnRefreshListener {
            checkReport()
        }
        checkReport()
        return rootView
    }

}