package org.chickenhook.androidexploits

import android.os.Build
import android.os.Bundle
import android.util.Log
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.ProgressBar
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import androidx.fragment.app.Fragment
import androidx.navigation.fragment.findNavController
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.appbar.AppBarLayout
import io.ktor.client.call.*
import org.chickenh00k.androidexploits.common.Report
import org.chickenh00k.androidexploits.common.communication.ScoreList
import org.chickenh00k.androidexploits.common.communication.ScoreListItem
import org.chickenhook.androidexploits.details.DetailsListFragment
import org.chickenhook.androidexploits.deviceOverview.DeviceOverviewFragment
import org.chickenhook.androidexploits.reportOverview.*
import org.chickenhook.androidexploits.tools.Converter.serverDateConverter
import java.text.SimpleDateFormat
import java.util.*
import kotlin.collections.ArrayList

/**
 * A simple [Fragment] subclass.
 * Use the [MyDeviceOverviewFragment.newInstance] factory method to
 * create an instance of this fragment.
 */
class MyDeviceOverviewFragment : Fragment() {

    companion object {
        var deviceReport: Report? = null
        const val TAG = "ReportOverviewFragment"
    }


    lateinit var rootView: View
    lateinit var overviewReportPb: ProgressBar
    lateinit var overviewStatusView: TextView

    fun onLoadingStart() {
        overviewReportPb.visibility = View.VISIBLE
        overviewStatusView.visibility = View.GONE
    }

    fun onLoadingEnd() {
        overviewReportPb.visibility = View.GONE
        overviewStatusView.visibility = View.GONE
    }

    fun onLoadingError(message: String) {
        overviewStatusView.visibility = View.VISIBLE
        overviewStatusView.setText(message)
    }


    fun getMainActivity(): MainActivity? {
        val activtiy = activity
        if (activtiy is MainActivity) {
            return activtiy
        }
        return null
    }


    fun openDeviceFragment(model: String, title: String) {
        val args = Bundle()
        args.putSerializable(DeviceOverviewFragment.ARG_MODEL, model)
        args.putSerializable(DeviceOverviewFragment.ARG_TITLE, title)
        findNavController().navigate(
            R.id.action_MyDeviceOverviewFragment_to_DeviceOverviewFragment,
            args
        )
    }


    fun sendRequest() {
        activity?.let {
            if (it is MainActivity) {
                it.getConnection { service ->
                    onLoadingStart()
                    service?.sendDeviceInfo { report ->
                        Log.d(TAG, "device info request sent")
                        it.runOnUiThread {
                            onLoadingEnd()
                            report?.let { report ->
                                deviceReport = report
                                onReport(rootView, report)
                            } ?: kotlin.run {
                                onLoadingError(getString(R.string.report_status_network_error))
                            }
                        }

                    }
                }
            } else {
                Log.d(TAG, "didn't text from service... not MainActivity")
            }
        } ?: kotlin.run {
            Log.d(TAG, "Fragment is not attached!")
        }
    }

    fun addScoreListItemAsync(
        activity: MainActivity,
        list: RecyclerView,
        values: ArrayList<IReportOverviewItem>,
        url: String,
        onClick: View.OnClickListener? = null
    ) {
        var item = GenericScoreItem()
        var id = values.size
        activity.runOnUiThread {
            values.add(id, item)
            list.adapter?.notifyItemInserted(id)
        }

        activity.sendGenericRequest<ScoreListItem>(url) {
            requireActivity().runOnUiThread {
                item.update(
                    it, onClick
                )

                list.adapter?.notifyItemChanged(id)
            }
        }
    }

    fun addHistoryItem(
        activity: MainActivity,
        list: RecyclerView,
        values: ArrayList<IReportOverviewItem>,
        url: String,
        onClick: View.OnClickListener? = null
    ) {

        val history = HashMap<Date, Double>()
        val item = HistoryItem(
            getString(R.string.score_history_label),
            history,
            onClick = onClick
        )
        val id = values.size
        values.add(item)

        list.adapter?.notifyItemInserted(id)

        activity.sendGenericRequest<ScoreList>(url) {
            it.items.forEach {
                serverDateConverter(it.name)?.let { date ->
                    history[date] = it.score
                }
            }
            requireActivity().runOnUiThread {
                list.adapter?.notifyItemChanged(id)
            }

        }
    }

    fun onReport(view: View, report: Report) {


        val values = ArrayList<IReportOverviewItem>()
        values.add(MyDeviceScoreItem(report.multiplier))

        val list = view.findViewById<RecyclerView>(R.id.report_card_overview_list)
        if (list is RecyclerView) {
            with(list) {
                layoutManager = LinearLayoutManager(context)
                adapter = DeviceCardReportAdapter(values)
            }
        }

        if (report.incidences.isNotEmpty()) {
            values.add(IncidencesItem(report.incidences))
            list.adapter?.notifyItemInserted(values.size)
        }


        getMainActivity()?.let { activity ->
            activity.getConnection { connection ->
                connection?.let { service ->
                    addHistoryItem(
                        activity,
                        list,
                        values,
                        "device/${service.getDeviceName()}/history/score"
                    ) {
                        activity.openDetails(
                            "manufacturer/${Build.MANUFACTURER}/devices/score",
                            Build.MANUFACTURER
                        )
                    }
                }
            }

            addScoreListItemAsync(
                activity,
                list,
                values,
                "androidVersionScore/${Build.VERSION.SDK_INT}"
            ) {
                activity.openDetails(
                    "androidversion/${Build.VERSION.SDK_INT}/devices/score",
                    Build.VERSION.SDK_INT.toString()
                )
            }

            addScoreListItemAsync(
                activity,
                list,
                values,
                "modelScore/${Build.MODEL}"
            ) { view ->
                openDeviceFragment(Build.MODEL, Build.MODEL)
            }
            addScoreListItemAsync(
                activity,
                list,
                values,
                "manufacturerScore/${Build.MANUFACTURER}"
            ) {
                activity.openDetails(
                    "manufacturer/${Build.MANUFACTURER}/devices/score",
                    Build.MANUFACTURER
                )
            }

        } ?: kotlin.run {
            Log.d(TAG, "Fragment is not attached!")
        }
    }

    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {

        // Inflate the layout for this fragment
        rootView = inflater.inflate(R.layout.fragment_report_card_overview, container, false)


        overviewReportPb = rootView.findViewById(R.id.progress_pb)
        overviewStatusView = rootView.findViewById(R.id.progress_status)
        deviceReport?.let { report ->
            onReport(rootView, report)
        } ?: kotlin.run {
            sendRequest()
        }
        return rootView
    }

}