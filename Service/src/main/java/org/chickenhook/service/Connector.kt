package org.chickenhook.service

import android.util.Log
import io.ktor.client.*
import io.ktor.client.engine.android.*
import io.ktor.client.request.*
import io.ktor.client.statement.*
import io.ktor.http.*
import io.ktor.serialization.kotlinx.json.*
import kotlinx.serialization.json.Json
import org.chickenhook.common.DeviceInfo

import io.ktor.client.HttpClient
import io.ktor.client.call.*
import io.ktor.client.engine.*
import io.ktor.client.engine.android.Android
import io.ktor.client.plugins.contentnegotiation.*
import io.ktor.client.plugins.logging.*
import io.ktor.client.request.header
import io.ktor.util.reflect.*
import org.chickenhook.common.DeviceReport
import java.security.KeyStore
import javax.net.ssl.HostnameVerifier
import javax.net.ssl.SSLContext
import javax.net.ssl.TrustManagerFactory
import javax.net.ssl.X509TrustManager


class Connector(val host: String = "http://192.168.0.62:8080/", val keyStore: KeyStore) { // h3003087.stratoserver.net


    fun getSslContext(): SSLContext {
        val tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm())
        tmf.init(keyStore)
        val sslContext = SSLContext.getInstance("TLS")
        sslContext.init(null, tmf.trustManagers, null)
        val x509TrustManager = tmf.trustManagers.first { it is X509TrustManager } as X509TrustManager

        return sslContext
    }

    //val service : ExecutorService = Executors.newSingleThreadExecutor()
    val client = HttpClient(Android.config {
        sslManager = { conn ->
            conn.sslSocketFactory = getSslContext().socketFactory
            conn.hostnameVerifier = HostnameVerifier { host, session ->
                // todo improve
                host.equals("h3003087.stratoserver.net")
            }
        }
    }) {

        install(Logging) {
            logger = object : Logger {
                override fun log(message: String) {
                    Log.v("Logger Ktor =>", message)
                }

            }
            level = LogLevel.ALL
        }

        install(ContentNegotiation) {
            json()
        }
    }


    suspend fun checkDevice(id: String, deviceInfo: DeviceInfo): DeviceReport? {
        return try {
            val response: HttpResponse = client.post("$host/check") {
                headers {
                    append(HttpHeaders.Authorization, id)
                }
                contentType(ContentType.Application.Json)
                this.setBody(deviceInfo)
            }
            response.body()
        } catch (exception: java.lang.Exception) {
            null
        }

    }
}