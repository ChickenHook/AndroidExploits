package org.chickenhook.service

import android.util.Log
import io.ktor.client.*
import io.ktor.client.engine.android.*
import io.ktor.client.request.*
import io.ktor.client.statement.*
import io.ktor.http.*
import io.ktor.serialization.kotlinx.json.*
import kotlinx.serialization.json.Json
import org.chickenhook.common.DeviceInfo

import io.ktor.client.HttpClient
import io.ktor.client.call.*
import io.ktor.client.engine.android.Android
import io.ktor.client.plugins.contentnegotiation.*
import io.ktor.client.plugins.logging.*
import io.ktor.client.request.header
import io.ktor.util.reflect.*
import org.chickenhook.common.DeviceReport


class Connector(val host: String = "http://192.168.0.62:8080/") { // h3003087.stratoserver.net


    //val service : ExecutorService = Executors.newSingleThreadExecutor()
    val client = HttpClient(Android) {


        install(Logging) {
            logger = object : Logger {
                override fun log(message: String) {
                    Log.v("Logger Ktor =>", message)
                }

            }
            level = LogLevel.ALL
        }

        install(ContentNegotiation) {
            json()
        }
    }


    suspend fun checkDevice(id: String, deviceInfo: DeviceInfo): DeviceReport? {
        return try {
            val response: HttpResponse = client.post("$host/check") {
                headers {
                    append(HttpHeaders.Authorization, id)
                }
                contentType(ContentType.Application.Json)
                this.setBody(deviceInfo)
            }
            response.body()
        } catch (exception: java.lang.Exception) {
            null
        }

    }
}