package org.chickenhook.service

import android.content.Context
import android.util.Log
import kotlinx.serialization.json.Json
import org.chickenh00k.androidexploits.common.Report
import java.io.File
import kotlinx.serialization.decodeFromString
import kotlinx.serialization.encodeToString

object CacheStorage {

    const val TAG = "CacheStorage"

    fun getReportPath(context: Context): File {
        return File(context.cacheDir.absolutePath + File.separator + context.getString(R.string.report_file_name))
    }

    fun storeReport(context: Context, report: Report): Boolean {
        val path = getReportPath(context)
        if(!path.createNewFile()) {
            if (!path.exists() || !path.canRead() || !path.canWrite() || path.length().toInt() == 0) {
                Log.d(TAG, "Unable to read file <${path}>")
                return false
            } else {
                path.delete()
            }
        }

        path.writeText(Json.encodeToString(report))
        return true
    }

    fun loadReport(context: Context): Report? {
        val path = getReportPath(context)
        if (!path.exists() || !path.canRead() || path.length().toInt() == 0) {
            Log.d(TAG, "Unable to read file <${path}>")
            return null
        }
        try {
            val data: Report = Json.decodeFromString(path.readText().trimIndent())
            return data
        } catch (exception: java.lang.Exception) {
            Log.e(TAG, "Unable to read file <${path}>", exception)
            return null
        }

    }
}