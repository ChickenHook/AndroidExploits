package org.chickenhook.service

import android.accessibilityservice.AccessibilityServiceInfo
import android.app.Service
import android.content.Context
import android.content.Intent
import android.content.pm.ApplicationInfo
import android.content.pm.PackageManager
import android.content.pm.ServiceInfo
import android.os.Binder
import android.os.Build
import android.os.IBinder
import android.provider.Settings.Secure.ANDROID_ID
import android.util.Log
import android.view.accessibility.AccessibilityManager
import kotlinx.coroutines.*
import org.chickenhook.common.DeviceInfo
import org.chickenhook.common.DeviceReport

class AndroidExploitsService : Service()
{

    val TAG = "AndroidExploitsService"

    fun getMetaData(context: Context?, metaDataKey: String?): Any? {
        if (context == null) {
            return null
        }
        var ai: ApplicationInfo? = null
        return try {
            ai = context.packageManager.getApplicationInfo(
                context.packageName,
                PackageManager.GET_META_DATA
            )
            ai.metaData[metaDataKey]
        } catch (e: Exception) {
            null
        }
    }

    fun collectHardwareInfo(deviceInfo: DeviceInfo) {
        Build::class.java.declaredFields.forEach {field ->
            val value = field.get(null)
            value?.let {
                if(it is String)
                    deviceInfo.data[field.name] = it
            }
        }
        Build.VERSION::class.java.declaredFields.forEach {field ->
            val value = field.get(null)
            value?.let {
                if(it is String)
                    deviceInfo.data[field.name] = it
            }
        }
    }

    fun collectProperties(deviceInfo: DeviceInfo) {
        val addProperty = { name:String ->
            val value = System.getProperty(name);
            value?.let {
                deviceInfo.data[name] = value
            }
        }
        addProperty("os.version")
        addProperty("ro.product.locale")
        addProperty("ro.oem.key1")
        addProperty("ro.crypto.state")
    }

    fun collectPackageInfos(deviceInfo: DeviceInfo) {
        val pm : PackageManager = packageManager
        val packages = pm.getInstalledPackages(PackageManager.GET_META_DATA)
        val source = ""
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
            packages.forEach {
                val source = pm.getInstallSourceInfo(it.packageName)
                Log.d(TAG, "app_source ${source.installingPackageName}")
            }
        } else {

        }
        val packagesHoldingPermission = pm.getPackagesHoldingPermissions(arrayOf(android.Manifest.permission.BIND_ACCESSIBILITY_SERVICE), PackageManager.GET_META_DATA)

        var accessibility_permission_apps = ""
        packagesHoldingPermission.forEach {
            accessibility_permission_apps += it.packageName
        }
        if(accessibility_permission_apps.isNotEmpty()){
            deviceInfo.data["ACCESSIBILITY_PERMISSION_APPS"] = accessibility_permission_apps
        }
    }

    fun collectAccessibilityInfos(deviceInfo: DeviceInfo) {
        val am: AccessibilityManager =
            getSystemService(Context.ACCESSIBILITY_SERVICE) as AccessibilityManager
        val enabledServices: List<AccessibilityServiceInfo> =
            am.getEnabledAccessibilityServiceList(AccessibilityServiceInfo.FEEDBACK_ALL_MASK)
        enabledServices.forEachIndexed {i, it ->
            val enabledServiceInfo: ServiceInfo = it.getResolveInfo().serviceInfo
            deviceInfo.data["AcessibilityService_$i"] = enabledServiceInfo.packageName+":" + enabledServiceInfo.permission
        }
    }

    fun collectDeviceInfo() : DeviceInfo {
        var deviceInfo = DeviceInfo()

        collectPackageInfos(deviceInfo)
        collectHardwareInfo(deviceInfo)
        collectProperties(deviceInfo)
        collectAccessibilityInfos(deviceInfo)

        return deviceInfo
    }

    override fun onBind(p0: Intent?): IBinder? {
        return ServiceBinder()
    }




    inner class ServiceBinder : Binder() {

        fun getDeviceInfo(): DeviceInfo {
            return collectDeviceInfo()
        }

        @OptIn(DelicateCoroutinesApi::class)
        fun sendDeviceInfo(callback: (report: DeviceReport?) -> Unit) {
            val deviceInfo = collectDeviceInfo()
            var url:String? = getMetaData(baseContext,"host") as String?
            val connector = if(url!= null) {
                Connector(url)
            }else{
                Connector()
            }
            GlobalScope.async {
                val res = connector.checkDevice(ANDROID_ID, deviceInfo)
                callback(res)
            }
        }
    }



}